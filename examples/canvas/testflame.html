<!doctype html><title>Example of firework.js</title>
<script src="gowiththeflow.js"></script>
<body><script>

	var urls	= [
		"../assets/images/flame/flame14.png"
	];


	var flow	= Flow();
	urls.forEach(function(url){
		Flow().seq(function(next){
			convertTremulousImage(url, function(resultImage, originalImage){
				console.log("image converted", resultImage);
				document.body.appendChild(resultImage);
				document.body.appendChild(originalImage);

				var canvas	= document.createElement('canvas');
				canvas.width	= 128;
				canvas.height	= 128;	
				var ctx		= canvas.getContext('2d');

				ctx.drawImage(resultImage, 0, 0);


				document.body.appendChild(ctx.canvas);
			})
		});
	})
	flow.seq(function(){
		console.log("all flow completed")
	})

	function convertTremulousImage(url, callback){
		var canvas	= document.createElement('canvas');
		canvas.width	= 128;
		canvas.height	= 128;
		var ctxDst	= canvas.getContext('2d');

		var image	= new Image;
		image.onload	= function(){
			var canvas	= document.createElement('canvas');
			canvas.width	= image.width;
			canvas.height	= image.height;	
			var ctxSrc	= canvas.getContext('2d');
			ctxSrc.drawImage(image, 0, 0);

			var imgData	= ctxSrc.getImageData(0, 0, canvas.width, canvas.height);
			var p		= imgData.data;

			// for stat
			var lumMax = -9999;
			var lumMin = +9999;
			for(var x = 0; x < canvas.width; x++){
				for(var y = 0; y < canvas.height; y++){
					var i	= (x+y*canvas.width)*4;
					// if(p[i+0] == 0 && p[i+1] == 0 && p[i+2] == 0 ){
					// 	p[i+3]	= 0;
					// }
					var luminance	= (0.2126*p[i+0]) + (0.7152*p[i+1]) + (0.0722*p[i+2])

					lumMin		= Math.min(luminance, lumMin)
					lumMax		= Math.max(luminance, lumMax)

					luminance	= Math.floor(luminance);
					p[i+3]		= luminance;
				}
			}
			//console.log("lumMin", lumMin)
			//console.log("lumMax", lumMax)
			//console.dir(imgData)
			ctxDst.putImageData(imgData, 0, 0);

			// notify the caller
			callback	&& callback(ctxDst.canvas, image);
		}
		// start the image download
		image.src	= url;
	}

</script></body>