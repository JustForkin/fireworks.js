<!doctype html><title>Example of firework.js</title>
<script src="../vendor/tquery-bundle.js"></script>
<script src="../../build/fireworks-bundle.js"></script>
<script src="../vendor/dat.gui.js"></script>

<script src="../flamethrower/tremulousparticlesloader.js"></script>

<body><script>
	var world	= tQuery.createWorld().boilerplate().start();
	//world.tRenderer().setClearColorHex( 0x00bbff, world.tRenderer().getClearAlpha() );
	world.tRenderer().setClearColorHex( 0x000000, world.tRenderer().getClearAlpha() );

	//world.removeCameraControls()
	world.tCamera().position.z	= 20;


	var container	= new THREE.Object3D();
	container.position.y	= -3;
	world.add(container);

	var url		= "../assets/images/lensflare2.jpg";
	
	//setAlphaFromLuminance()
	var url		= "../assets/images/tremulous/psaw/blue_particle.jpg";
	var texture	= THREE.ImageUtils.loadTexture( url, undefined, function(image){
		var multiplier	= 4;
		var power	= 2;
		console.log('loaded image', arguments)
		// create a canvas
		var canvas	= document.createElement('canvas');
		canvas.width	= image.width;
		canvas.height	= image.height;	
		var ctx		= canvas.getContext('2d');
		// draw the image in it
		ctx.drawImage(image, 0, 0);
		
		// create an alpha channel based on color luminance
		var imgData	= ctx.getImageData(0, 0, canvas.width, canvas.height);
		var p		= imgData.data;
		for(var i = 0, y = 0; y < canvas.height; y++){
			for(var x = 0; x < canvas.width; x++, i += 4){
				var luminance	= (0.2126*p[i+0]) + (0.7152*p[i+1]) + (0.0722*p[i+2]);
				luminance	= Math.pow(luminance/255, power)*255;
				p[i+3]		= luminance * multiplier;
			}
		}
		// put the generated image in the canvas
		ctx.putImageData(imgData, 0, 0);
		// update the texture object now
		texture.image		= canvas;
		texture.needsUpdate	= true;
	});

	var emitter	= Fireworks.createEmitter({nParticles : 50})
		.useSpawnerSteadyRate(10)
		.bindTriggerDomEvents()
		.effectsStackBuilder()
			.position(Fireworks.createShapePoint(0, 0, 0))
			.velocity(Fireworks.createShapeSphere(0, 60, 0, 20), 20)
			.lifeTime(2, 3)
			//.randomVelocityDrift(Fireworks.createVector(10,10,0))
			.acceleration({
				effectId	: 'gravity',
				shape		: Fireworks.createShapePoint(0, -30, 0)
			})
			.createEffect('ground', {
					positionY	: 0,
					restitution	: 0.6
				}).onUpdate(function(particle, deltaTime){
					var position	= particle.get('position').vector;
					var velocity	= particle.get('velocity').vector;
					if( position.y <= this.opts.positionY ){
						position.y	= this.opts.positionY;
						velocity.y	= -velocity.y * this.opts.restitution;
					}
				}).back()
			.createEffect('scale', {
					origin	: 1/20,
					gradient: Fireworks.createLinearGradient()
							.push(0.00, 1.00)
							.push(0.05, 1.00)
							.push(0.10, 2.00)
							.push(0.80, 1.00) 
							.push(1.00, 0.00)
				}).onUpdate(function(particle){
					var object3d	= particle.get('threejsObject3D').object3d;
					var canonAge	= particle.get('lifeTime').normalizedAge();
					var scale	= this.opts.gradient.get(canonAge) * this.opts.origin;
					object3d.scale.set(scale, scale, scale);
				}).back()
			.createEffect('rotation')
				.onBirth(function(particle){
					var object3d	= particle.get('threejsObject3D').object3d;
					object3d.rotation	= Math.random()*Math.PI*2;
				}).back()
			.createEffect('opacity', {
					gradient: Fireworks.createLinearGradient()
							.push(0.00, 0.00)
							.push(0.05, 1.00)
							.push(0.95, 1.00) 
							.push(1.00, 0.00)
				}).onUpdate(function(particle){
					var object3d	= particle.get('threejsObject3D').object3d;
					var canonAge	= particle.get('lifeTime').normalizedAge();
					object3d.opacity= this.opts.gradient.get(canonAge);
				}).back()
			.renderToThreejsObject3D({
				container	: container,
				create		: function(){
					var object3d	= new THREE.Sprite({
						useScreenCoordinates	: false,
						map			: texture,
						transparent		: true
					});
					return object3d;
				}	
			})
			.back()
		.start();

	// update the emitter in rendering loop
	world.loop().hook(function(delta, now){
		emitter.update(delta).render();
	})
</script></body>











