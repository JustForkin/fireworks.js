var Fireworks={Emitter:function(a){this._nParticles=void 0!==a.nParticles?a.nParticles:100;this._particles=[];this._spawner=null;this._effects=[];this._started=!1;this._onUpdated=null}};Fireworks.Emitter.prototype.destroy=function(){this._effects.forEach(function(a){a.destroy()});this._spawner&&this._spawner.destroy();this._particles.forEach(function(a){a.destroy()})};Fireworks.Emitter.prototype.effects=function(){return this._effects};Fireworks.Emitter.prototype.particles=function(){return this._particles};
Fireworks.Emitter.prototype.liveParticles=function(){return this._liveParticles};Fireworks.Emitter.prototype.deadParticles=function(){return this._deadParticles};Fireworks.Emitter.prototype.nParticles=function(){return this._nParticles};Fireworks.Emitter.prototype.setSpawner=function(a){this._spawner=a;return this};Fireworks.Emitter.prototype.setParticleData=function(a,b,c){a[b]=c};Fireworks.Emitter.prototype.getParticleData=function(a,b){console.assert(void 0!==a[b],"namespace undefined: "+b);return a[b]};
Fireworks.Emitter.prototype.start=function(){console.assert(this._spawner,"a spawner MUST be set");console.assert(0<this._effects.length,"Some effects MUST be set");console.assert(!1===this._started);this._particles=Array(this._nParticles);for(var a=0;a<this._nParticles;a++)this._particles[a]=new Fireworks.Particle;this._liveParticles=[];this._deadParticles=this._particles.slice(0);this._started=!0;this._effects.forEach(function(a){a.onCreate&&this._particles.forEach(function(c,d){a.onCreate(c,d)})}.bind(this));
return this};Fireworks.Emitter.prototype.update=function(a){this._spawner.update(this,a);this._effects.forEach(function(b){b.onUpdate&&this._liveParticles.forEach(function(c){b.onUpdate(c,a)})}.bind(this));return this};Fireworks.Emitter.prototype.render=function(){this._effects.forEach(function(a){if(a.onPreRender)a.onPreRender()}.bind(this));this._effects.forEach(function(a){a.onRender&&this._liveParticles.forEach(function(b){a.onRender(b)})}.bind(this));return this};
Fireworks.Emitter.prototype.killParticle=function(a){var b=this._liveParticles.indexOf(a);console.assert(-1!==b);this._liveParticles.splice(b,1);this._deadParticles.push(a);this.effects().forEach(function(b){b.onDeath&&b.onDeath(a)}.bind(this))};Fireworks.Emitter.prototype.spawnParticle=function(){var a=this.deadParticles().pop();this.liveParticles().push(a);this.effects().forEach(function(b){b.onBirth&&b.onBirth(a)}.bind(this))};Fireworks.Spawner=function(){};Fireworks.Particle=function(){};
Fireworks.createEffect=function(a,b){"object"===typeof a&&(b=a,a=void 0);console.log("createEffect",a,b);var c=new Fireworks.Effect;c.opts=b;c.name=a;var d={onCreate:function(a){c.onCreate=a;return d},onBirth:function(a){c.onBirth=a;return d},onUpdate:function(a){c.onUpdate=a;return d},onDeath:function(a){c.onDeath=a;return d},onPreRender:function(a){c.onPreRender=a;return d},onRender:function(a){c.onRender=a;return d},pushTo:function(a){a.effects().push(c);return d},effect:function(){return c}};
return d};Fireworks.Effect=function(){};Fireworks.Shape=function(){};Fireworks.Vector=function(a,b,c){this.x=a||0;this.y=b||0;this.z=c||0};
Fireworks.Vector.prototype={constructor:Fireworks.Vector,set:function(a,b,c){this.x=a;this.y=b;this.z=c;return this},setX:function(a){this.x=a;return this},setY:function(a){this.y=a;return this},setZ:function(a){this.z=a;return this},random:function(){this.x=Math.random()-0.5;this.y=Math.random()-0.5;this.z=Math.random()-0.5;return this},toString:function(){return JSON.stringify(this)},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;return this},add:function(a,b){this.x=a.x+b.x;this.y=a.y+b.y;this.z=
a.z+b.z;return this},addSelf:function(a){this.x+=a.x;this.y+=a.y;this.z+=a.z;return this},addScalar:function(a){this.x+=a;this.y+=a;this.z+=a;return this},sub:function(a,b){this.x=a.x-b.x;this.y=a.y-b.y;this.z=a.z-b.z;return this},subSelf:function(a){this.x-=a.x;this.y-=a.y;this.z-=a.z;return this},multiply:function(a,b){this.x=a.x*b.x;this.y=a.y*b.y;this.z=a.z*b.z;return this},multiplySelf:function(a){this.x*=a.x;this.y*=a.y;this.z*=a.z;return this},multiplyScalar:function(a){this.x*=a;this.y*=a;
this.z*=a;return this},divideSelf:function(a){this.x/=a.x;this.y/=a.y;this.z/=a.z;return this},divideScalar:function(a){a?(this.x/=a,this.y/=a,this.z/=a):this.z=this.y=this.x=0;return this},negate:function(){return this.multiplyScalar(-1)},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.lengthSq())},normalize:function(){return this.divideScalar(this.length())},setLength:function(a){return this.normalize().multiplyScalar(a)},
cross:function(a,b){this.x=a.y*b.z-a.z*b.y;this.y=a.z*b.x-a.x*b.z;this.z=a.x*b.y-a.y*b.x;return this},crossSelf:function(a){var b=this.x,c=this.y,d=this.z;this.x=c*a.z-d*a.y;this.y=d*a.x-b*a.z;this.z=b*a.y-c*a.x;return this},distanceTo:function(a){return Math.sqrt(this.distanceToSquared(a))},distanceToSquared:function(a){return(new Fireworks.Vector).sub(this,a).lengthSq()},equals:function(a){return a.x===this.x&&a.y===this.y&&a.z===this.z},isZero:function(){return 1.0E-4>this.lengthSq()},clone:function(){return new Fireworks.Vector(this.x,
this.y,this.z)}};Fireworks.Emitter.prototype.pushAge=function(a,b){1===arguments.length&&(b=a);this.effects().push(new Fireworks.EffectAge(this,a,b));return this};Fireworks.EffectAge=function(a,b,c){console.assert(void 0!==b);console.assert(void 0!==c);this.onCreate=function(a){a.xAge={curAge:0,minAge:0,maxAge:0}}.bind(this);this.onBirth=function(a){a=a.xAge;a.curAge=0;a.maxAge=b+Math.random()*(c-b)}.bind(this);this.onUpdate=function(b,c){var e=b.xAge;e.curAge+=c;e.curAge>e.maxAge&&a.killParticle(b)}.bind(this)};
Fireworks.EffectAge.prototype=new Fireworks.Effect;Fireworks.EffectAge.prototype.constructor=Fireworks.EffectAge;Fireworks.Effect.ApplyForce=function(a,b){this.onUpdate=function(c){a.getParticleData(c,"xBase").position.addSelf(b.vector)}.bind(this)};Fireworks.Effect.ApplyForce.prototype=new Fireworks.Effect;Fireworks.Effect.ApplyForce.prototype.constructor=Fireworks.Effect.ApplyForce;Fireworks.Emitter.prototype.pushBase=function(a){this.effects().push(new Fireworks.EffectBase(this,a));return this};
Fireworks.EffectBase=function(a){this.name="Base";this.opts={friction:0.99,birthPosition:new Fireworks.Vector(0,0,0),birthVelocity:new Fireworks.Vector(1,0,0),birthAcceleration:new Fireworks.Vector(0,0,0)};this.onCreate=function(b){a.setParticleData(b,"xBase",{position:new Fireworks.Vector,velocity:new Fireworks.Vector,acceleration:new Fireworks.Vector,friction:this.opts.friction})}.bind(this);this.onBirth=function(b){b=a.getParticleData(b,"xBase");b.position.copy(this.opts.birthPosition);b.velocity.copy(this.opts.birthVelocity);
b.acceleration.copy(this.opts.birthAcceleration);b.friction=this.opts.friction}.bind(this);this.onUpdate=function(a){a=a.xBase;a.velocity.addSelf(a.acceleration);a.velocity.multiplyScalar(a.friction);a.position.addSelf(a.velocity)}.bind(this)};Fireworks.EffectBase.prototype=new Fireworks.Effect;Fireworks.EffectBase.prototype.constructor=Fireworks.EffectBase;Fireworks.Emitter.prototype.pushDieIfContained=function(a){this.effects().push(new Fireworks.Effect.DieIfContained(this,a))};
Fireworks.Effect.DieIfContained=function(a,b){this.onUpdate=function(c){var d=a.getParticleData(c,"xBase").position;b.contains(d)&&a.killParticle(c)}.bind(this)};Fireworks.Effect.DieIfContained.prototype=new Fireworks.Effect;Fireworks.Effect.DieIfContained.prototype.constructor=Fireworks.Effect.DieIfContained;Fireworks.Emitter.prototype.pushInit2Shapes=function(a){this.effects().push(new Fireworks.Effect.Init2Shapes(this,a));return this};
Fireworks.Effect.Init2Shapes=function(a,b){console.assert(b.origin instanceof Fireworks.Shape);console.assert(b.target instanceof Fireworks.Shape);b.speed=void 0!==b.speed?b.speed:1;this.opts=b;this.name="Init2Shapes";this.onBirth=function(c){c=a.getParticleData(c,"xBase");c.position.copy(b.origin.randomPoint());var d=b.target.randomPoint().subSelf(c.position);d.setLength(b.speed);c.velocity.copy(d)}.bind(this)};Fireworks.Effect.Init2Shapes.prototype=new Fireworks.Effect;
Fireworks.Effect.Init2Shapes.prototype.constructor=Fireworks.Effect.Init2Shapes;Fireworks.createBox=function(a,b,c,d,g,e){a=new Fireworks.Vector(a,b,c);d=new Fireworks.Vector(d,g,e);return new Fireworks.Shape.Box(a,d)};Fireworks.Shape.Box=function(a,b){this.center=a;this.size=b;this._vector=new Fireworks.Vector};Fireworks.Shape.Box.prototype=new Fireworks.Shape;Fireworks.Shape.Box.prototype.constructor=Fireworks.Shape.Box;
Fireworks.Shape.Box.prototype.contains=function(a){a=this._vector.sub(a,this.center);return Math.abs(a.x)>this.size.x/2||Math.abs(a.y)>this.size.y/2||Math.abs(a.z)>this.size.z/2?!1:!0};Fireworks.Shape.Box.prototype.randomPoint=function(){var a=this._vector;a.x=Math.random()*this.size.x-this.size.x/2;a.y=Math.random()*this.size.y-this.size.y/2;a.z=Math.random()*this.size.z-this.size.z/2;a.addSelf(this.center);return a};
Fireworks.DatGui4Emitter=function(a){var b=new dat.GUI;a.effects().forEach(function(a,d){var g=a.name||"effect-"+d,e=a.opts||{},h=Object.keys(e).filter(function(a){return e[a]instanceof Fireworks.Vector?!0:"object"===typeof e[a]?!1:!0});if(h.length){var f=b.addFolder("Effect: "+g);h.forEach(function(a){e[a]instanceof Fireworks.Vector?(f.add(e[a],"x").name(a+"X"),f.add(e[a],"y").name(a+"Y"),f.add(e[a],"z").name(a+"Z")):f.add(e,a)})}});return b};
Fireworks.createSphere=function(a,b,c,d){a=new Fireworks.Vector(a,b,c);return new Fireworks.ShapeSphere(a,d)};Fireworks.ShapeSphere=function(a,b){this.center=a;this.radius=b;this._vector=new Fireworks.Vector};Fireworks.ShapeSphere.prototype=new Fireworks.Shape;Fireworks.ShapeSphere.prototype.constructor=Fireworks.ShapeSphere;Fireworks.ShapeSphere.prototype.contains=function(a){return this._vector.sub(a,this.center).length()<=this.radius};
Fireworks.ShapeSphere.prototype.randomPoint=function(){var a=this._vector;a.x=Math.random()-0.5;a.y=Math.random()-0.5;a.z=Math.random()-0.5;var b=Math.random()*this.radius;a.setLength(b);a.addSelf(this.center);return a};Fireworks.SpawnerOneShot=function(a){this._nParticles=a||1;this._completed=!1};Fireworks.SpawnerOneShot.prototype=new Fireworks.Spawner;Fireworks.SpawnerOneShot.prototype.constructor=Fireworks.SpawnerOneShot;
Fireworks.SpawnerOneShot.prototype.update=function(a){if(!this._completed){for(var b=0;b<this._nParticles;b++)a.spawnParticle();this._completed=!0}};Fireworks.SpawnerRate=function(a){this._rate=a||10;this._nToCreate=1};Fireworks.SpawnerRate.prototype=new Fireworks.Spawner;Fireworks.SpawnerRate.prototype.constructor=Fireworks.SpawnerRate;
Fireworks.SpawnerRate.prototype.update=function(a,b){this._nToCreate+=this._rate*b;var c=Math.floor(this._nToCreate),c=Math.min(c,a.deadParticles().length);this._nToCreate-=c;for(var d=0;d<c;d++)a.spawnParticle()};
